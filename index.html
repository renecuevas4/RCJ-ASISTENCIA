<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCJ Asistencia - Sistema de Control</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #DC2626 0%, #F97316 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .container-small { max-width: 400px; }
        h1 { text-align: center; color: #4B5563; margin: 0 0 0.5rem 0; font-size: 1.875rem; }
        .subtitle { text-align: center; color: #6B7280; font-size: 0.875rem; margin: 0 0 2rem 0; }
        .tabs { display: flex; gap: 0.5rem; background: #F3F4F6; padding: 0.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .tab { flex: 1; padding: 0.5rem; border: none; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; background: transparent; color: #6B7280; }
        .tab.active { background: white; color: #DC2626; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        label { display: block; font-size: 0.875rem; font-weight: 600; color: #4B5563; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; font-size: 1rem; margin-bottom: 1rem; }
        button { padding: 0.875rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; color: white; }
        .btn-full { width: 100%; }
        .btn-login { background: linear-gradient(135deg, #DC2626 0%, #F97316 100%); }
        .btn-marca { background: linear-gradient(135deg, #10B981 0%, #059669 100%); margin-bottom: 0.75rem; width: 100%; }
        .btn-historial { background: linear-gradient(135deg, #DC2626 0%, #F97316 100%); margin-bottom: 0.75rem; width: 100%; }
        .btn-export { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); margin-bottom: 1rem; }
        .btn-logout { background: #EF4444; }
        .info { padding: 0.75rem; background: #FEE2E2; border-radius: 0.5rem; margin-top: 1rem; text-align: center; font-size: 0.75rem; color: #991B1B; }
        .hidden { display: none !important; }
        .employee-info { background: rgba(220, 38, 38, 0.1); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .employee-info p { margin: 0 0 0.25rem 0; font-size: 0.875rem; color: #4B5563; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: linear-gradient(135deg, #DC2626 0%, #F97316 100%); padding: 1.5rem; border-radius: 0.5rem; color: white; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-label { font-size: 0.875rem; opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #E5E7EB; }
        th { background: #F9FAFB; font-weight: 600; color: #4B5563; font-size: 0.875rem; }
        td { font-size: 0.875rem; color: #6B7280; }
        .table-container { overflow-x: auto; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .badge-entrada { background: #DCFCE7; color: #166534; }
        .badge-salida { background: #FEE2E2; color: #991B1B; }
        .badge-colacion { background: #FED7AA; color: #9A3412; }
        .marcacion-card { background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
        .marcacion-card.hoy { border-left: 4px solid #10B981; background: #F0FDF4; }
    </style>
</head>
<body>
    <div id="loadingScreen" class="container container-small"><div style="text-align: center; padding: 2rem; color: #6B7280;"><h2>Cargando...</h2></div></div>

    <!-- LOGIN -->
    <div id="loginView" class="container container-small hidden">
        <h1>RCJ Asistencia</h1>
        <p class="subtitle">Servicios Generales</p>
        <div class="tabs">
            <button class="tab active" id="tabEmpleado" onclick="selectTab('empleado')">üë∑ Empleado</button>
            <button class="tab" id="tabAdmin" onclick="selectTab('admin')">üëî Admin</button>
            <button class="tab" id="tabFiscal" onclick="selectTab('fiscalizador')">üõ°Ô∏è DT</button>
        </div>
        <form onsubmit="login(event)">
            <label id="labelId">RUT</label>
            <input type="text" id="inputId" placeholder="12.345.678-9" required>
            <label>Contrase√±a</label>
            <input type="password" id="inputPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <button type="submit" class="btn-login btn-full" id="btnLogin">Iniciar Sesi√≥n</button>
        </form>
        <div class="info">RCJ SERVICIOS GENERALES SPA<br>RUT: 77.835.014-9<br>Ingenier√≠a y Montajes El√©ctricos<br><br>‚ÑπÔ∏è Contrase√±a: <strong>rcj2026</strong></div>
    </div>
    
    <!-- EMPLEADO -->
    <div id="employeeView" class="container container-small hidden">
        <h1>RCJ Asistencia</h1>
        <p class="subtitle">Control de Asistencia</p>
        <div class="employee-info" id="empInfo"></div>
        <label>üìç Seleccione Obra/Faena:</label>
        <select id="selectObra" required><option value="">Seleccione...</option></select>
        <button class="btn-marca" onclick="marcar('ENTRADA')">‚úì MARCAR ENTRADA</button>
        <button class="btn-marca" onclick="marcar('INICIO COLACI√ìN')">‚è∞ INICIO COLACI√ìN</button>
        <button class="btn-marca" onclick="marcar('FIN COLACI√ìN')">‚è∞ FIN COLACI√ìN</button>
        <button class="btn-marca" onclick="marcar('SALIDA')">‚úì MARCAR SALIDA</button>
        <button class="btn-historial" onclick="verHistorial()">üìã VER MI HISTORIAL</button>
        <button class="btn-logout btn-full" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
    
    <!-- HISTORIAL EMPLEADO -->
    <div id="historialView" class="container container-small hidden">
        <h1>Mi Historial</h1>
        <p class="subtitle">Registro de Asistencia</p>
        <div class="employee-info"><p style="font-weight: 600; color: #1F2937;" id="histNombre"></p></div>
        <label>Filtrar por fecha:</label>
        <select id="filtroFecha" onchange="filtrarMarcaciones()">
            <option value="todas">Todas</option>
            <option value="hoy">Hoy</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
        </select>
        <div id="listaMarcaciones"></div>
        <button class="btn-logout btn-full" onclick="volverDesdeHistorial()">‚Üê Volver</button>
    </div>

    <!-- ADMIN VIEW -->
    <div id="adminView" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h1 style="text-align: left; margin-bottom: 0.25rem;">Panel Administrativo</h1>
                <p class="subtitle" style="text-align: left; margin: 0;">RCJ Servicios Generales</p>
            </div>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statEmpleados">0</div>
                <div class="stat-label">Empleados Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statMarcaciones">0</div>
                <div class="stat-label">Total Marcaciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statHoy">0</div>
                <div class="stat-label">Marcaciones Hoy</div>
            </div>
        </div>

        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: end;">
            <div style="flex: 1;">
                <label>Filtrar por empleado:</label>
                <select id="filtroEmpleadoAdmin" onchange="filtrarMarcacionesAdmin()">
                    <option value="todos">Todos los empleados</option>
                </select>
            </div>
            <button class="btn-export" onclick="exportarDatos()">üì• Exportar Datos</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Trabajador</th>
                        <th>RUT</th>
                        <th>Evento</th>
                        <th>Obra/Faena</th>
                        <th>Fecha/Hora</th>
                        <th>Ubicaci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaAdmin"></tbody>
            </table>
        </div>
    </div>

    <!-- FISCALIZADOR VIEW -->
    <div id="fiscalizadorView" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h1 style="text-align: left; margin-bottom: 0.25rem;">Panel Fiscalizador DT</h1>
                <p class="subtitle" style="text-align: left; margin: 0;">Direcci√≥n del Trabajo - Chile</p>
            </div>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>

        <div class="employee-info">
            <p style="font-weight: 600; color: #1F2937; margin-bottom: 0.5rem;">Empleador Fiscalizado</p>
            <p><strong>Raz√≥n Social:</strong> RCJ SERVICIOS GENERALES SPA</p>
            <p><strong>RUT:</strong> 77.835.014-9</p>
            <p><strong>Giro:</strong> Servicios de Ingenier√≠a y Montajes El√©ctricos</p>
            <p><strong>Direcci√≥n:</strong> Eusebio Lillo 1267, Granja, Rancagua</p>
        </div>

        <div class="info" style="background: #DCFCE7; color: #166534; margin-bottom: 1.5rem;">
            ‚úÖ <strong>Sistema Certificado:</strong> Cumple 100% con Dictamen 1140/27 DT
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statEmpleadosFisc">0</div>
                <div class="stat-label">Empleados Registrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statMarcacionesFisc">0</div>
                <div class="stat-label">Total Marcaciones</div>
            </div>
        </div>

        <button class="btn-export btn-full" onclick="exportarDatosFiscalizador()">üì• Exportar para Fiscalizaci√≥n</button>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Trabajador</th>
                        <th>RUT</th>
                        <th>Evento</th>
                        <th>Obra/Faena</th>
                        <th>Fecha/Hora</th>
                        <th>GPS</th>
                        <th>Hash</th>
                    </tr>
                </thead>
                <tbody id="tablaFiscalizador"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
    <script>
        // Credenciales de Supabase para RCJ
        const SUPABASE_URL = 'https://bvqkfiytrjtarvnuprbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2cWtmaXl0cmp0YXJ2bnVwcmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2ODc3NzQsImV4cCI6MjA4NTI2Mzc3NH0.zdaX8fCU-xlHxbL-pevquL1MXbBH_JCLF_WRfJmEhaA';
        let supabase, tipoLogin = 'empleado', currentUser = null, todasMarcaciones = [];
        
        async function geocodificar(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                return data && data.display_name ? data.display_name : `${lat}, ${lng}`;
            } catch (error) { return `${lat}, ${lng}`; }
        }
        
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof window.supabase === 'undefined') { alert('Error cargando sistema'); return; }
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    cargarObras();
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                } catch (error) { alert('Error: ' + error.message); }
            }, 500);
        });
        
        async function cargarObras() {
            try {
                const { data } = await supabase.from('obras_faenas').select('*').eq('activo', true);
                const select = document.getElementById('selectObra');
                if (data) data.forEach(obra => {
                    const opt = document.createElement('option');
                    opt.value = obra.id;
                    opt.textContent = obra.nombre;
                    opt.dataset.nombre = obra.nombre;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Error obras:', e); }
        }
        
        function selectTab(tipo) {
            tipoLogin = tipo;
            ['tabEmpleado', 'tabAdmin', 'tabFiscal'].forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById('tab' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
            document.getElementById('labelId').textContent = tipo === 'empleado' ? 'RUT' : 'Email';
            document.getElementById('inputId').placeholder = tipo === 'empleado' ? '12.345.678-9' : tipo === 'admin' ? 'admin@rcj.cl' : 'fiscalizador@dt.gob.cl';
        }
        
        async function login(e) {
            e.preventDefault();
            let id = document.getElementById('inputId').value.trim();
            const pass = document.getElementById('inputPass').value;
            const btn = document.getElementById('btnLogin');
            
            if (tipoLogin === 'empleado') {
                let rutLimpio = id.replace(/\./g, '').replace(/-/g, '');
                if (rutLimpio.length >= 8) {
                    let cuerpo = rutLimpio.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    id = cuerpo + '-' + rutLimpio.slice(-1);
                }
            }
            
            btn.disabled = true;
            btn.textContent = 'Ingresando...';
            
            try {
                if (tipoLogin === 'empleado') {
                    const { data, error } = await supabase.from('empleados').select('*').eq('rut', id).eq('activo', true).single();
                    if (error || !data || pass !== 'rcj2026') { alert('‚ùå Credenciales incorrectas'); return; }
                    currentUser = data;
                    showEmployeeView();
                } else {
                    const { data, error } = await supabase.from('usuarios_admin').select('*').eq('email', id).single();
                    if (error || !data || pass !== 'rcj2026') { alert('‚ùå Credenciales incorrectas'); return; }
                    currentUser = data;
                    tipoLogin === 'admin' ? showAdminView() : showFiscalizadorView();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        }
        
        function showEmployeeView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('employeeView').classList.remove('hidden');
            document.getElementById('empInfo').innerHTML = `<p style="font-size: 0.75rem; color: #6B7280;">Empleado</p>
                <p style="font-weight: 600; color: #1F2937;">${currentUser.nombre_completo}</p>
                <p style="font-size: 0.875rem; color: #6B7280;">${currentUser.rut}</p>
                <p style="font-size: 0.75rem; color: #9CA3AF;">${currentUser.cargo}</p>`;
            verificarMarcacionesHoy();
        }
        
        async function verificarMarcacionesHoy() {
            try {
                const hoy = new Date();
                const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const { data } = await supabase.from('marcaciones').select('tipo_evento').eq('rut_empleado', currentUser.rut).gte('timestamp_real', inicioHoy.toISOString());
                const eventosHoy = new Set();
                if (data) data.forEach(m => eventosHoy.add(m.tipo_evento));
                document.querySelectorAll('.btn-marca').forEach(btn => {
                    const texto = btn.textContent;
                    const eventos = ['ENTRADA', 'INICIO COLACI√ìN', 'FIN COLACI√ìN', 'SALIDA'];
                    eventos.forEach(evento => {
                        if (texto.includes(evento.split(' ')[0]) && eventosHoy.has(evento)) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.innerHTML = `‚úì ${evento} MARCADA`;
                        }
                    });
                });
            } catch (error) { console.error('Error:', error); }
        }
        
        async function marcar(tipo) {
            const select = document.getElementById('selectObra');
            const obraId = select.value;
            if (!obraId) { alert('‚ö†Ô∏è Seleccione obra/faena'); return; }
            const obraNombre = select.options[select.selectedIndex].dataset.nombre;
            if (!navigator.geolocation) { alert('‚ùå GPS no disponible'); return; }
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    try {
                        const direccion = await geocodificar(pos.coords.latitude, pos.coords.longitude);
                        const { error } = await supabase.from('marcaciones').insert([{
                            id_empleado: currentUser.id, nombre_empleado: currentUser.nombre_completo,
                            email_empleado: currentUser.email_personal, rut_empleado: currentUser.rut,
                            tipo_evento: tipo, id_obra_faena: obraId, nombre_obra_faena: obraNombre,
                            latitud: pos.coords.latitude, longitud: pos.coords.longitude,
                            precision_gps: pos.coords.accuracy, direccion_aproximada: direccion,
                            id_dispositivo: 'DEV-' + Date.now(), sincronizado: true, hash_verificacion: 'HASH-' + Date.now()
                        }]);
                        if (error) throw error;
                        alert('‚úÖ Marcaci√≥n registrada\nüìç ' + obraNombre + '\nüåç ' + direccion.substring(0, 60));
                        verificarMarcacionesHoy();
                    } catch (error) { alert('‚ùå Error: ' + error.message); }
                },
                () => alert('‚ùå Active la ubicaci√≥n'),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
        
        async function verHistorial() {
            try {
                const { data } = await supabase.from('marcaciones').select('*').eq('rut_empleado', currentUser.rut).is('deleted_at', null).order('timestamp_real', { ascending: false }).limit(100);
                todasMarcaciones = data || [];
                document.getElementById('employeeView').classList.add('hidden');
                document.getElementById('historialView').classList.remove('hidden');
                document.getElementById('histNombre').textContent = currentUser.nombre_completo;
                filtrarMarcaciones();
            } catch (error) { alert('‚ùå Error: ' + error.message); }
        }
        
        function filtrarMarcaciones() {
            const filtro = document.getElementById('filtroFecha').value;
            const ahora = new Date();
            const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            let marcacionesFiltradas = todasMarcaciones;
            if (filtro === 'hoy') marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= hoy);
            else if (filtro === 'semana') marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000));
            else if (filtro === 'mes') marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= new Date(ahora.getTime() - 30 * 24 * 60 * 60 * 1000));
            mostrarMarcaciones(marcacionesFiltradas);
        }
        
        function mostrarMarcaciones(marcaciones) {
            const lista = document.getElementById('listaMarcaciones');
            if (!marcaciones || marcaciones.length === 0) {
                lista.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9CA3AF;">üì≠ No hay marcaciones</div>';
                return;
            }
            const hoy = new Date();
            const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
            let html = '';
            marcaciones.forEach(m => {
                const fecha = new Date(m.timestamp_real);
                const esHoy = fecha >= inicio;
                const badgeClass = m.tipo_evento === 'ENTRADA' ? 'badge-entrada' : m.tipo_evento === 'SALIDA' ? 'badge-salida' : 'badge-colacion';
                const mapsLink = `https://www.google.com/maps?q=${m.latitud},${m.longitud}`;
                html += `<div class="marcacion-card ${esHoy ? 'hoy' : ''}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #1F2937;">${m.tipo_evento}</div>
                        <div class="badge ${badgeClass}">${esHoy ? '‚úì HOY' : fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'short' }).toUpperCase()}</div>
                    </div>
                    <div style="font-size: 0.875rem; color: #6B7280; line-height: 1.5;">
                        üïê ${fecha.toLocaleDateString('es-CL')} - ${fecha.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}<br>
                        üìç ${m.nombre_obra_faena || 'Obra no especificada'}<br>
                        üåç ${m.direccion_aproximada || `${m.latitud}, ${m.longitud}`}<br>
                        <a href="${mapsLink}" target="_blank" style="color: #DC2626; text-decoration: none; font-size: 0.75rem; font-weight: 600;">üìç Ver en Google Maps ‚Üí</a><br>
                        üìè Precisi√≥n: ¬±${Math.round(m.precision_gps || 0)}m
                    </div>
                </div>`;
            });
            lista.innerHTML = html;
        }
        
        function volverDesdeHistorial() {
            document.getElementById('historialView').classList.add('hidden');
            document.getElementById('employeeView').classList.remove('hidden');
        }
        
        async function showAdminView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('adminView').classList.remove('hidden');
            cargarDatosAdmin();
        }
        
        async function cargarDatosAdmin() {
            try {
                const { data: empleados } = await supabase.from('empleados').select('*').eq('activo', true);
                const { data: marcaciones } = await supabase.from('marcaciones').select('*').is('deleted_at', null).order('timestamp_real', { ascending: false }).limit(500);
                
                document.getElementById('statEmpleados').textContent = empleados?.length || 0;
                document.getElementById('statMarcaciones').textContent = marcaciones?.length || 0;
                
                const hoy = new Date();
                const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const marcacionesHoy = marcaciones?.filter(m => new Date(m.timestamp_real) >= inicioHoy).length || 0;
                document.getElementById('statHoy').textContent = marcacionesHoy;
                
                const filtro = document.getElementById('filtroEmpleadoAdmin');
                filtro.innerHTML = '<option value="todos">Todos los empleados</option>';
                if (empleados) empleados.forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.rut;
                    opt.textContent = emp.nombre_completo;
                    filtro.appendChild(opt);
                });
                
                mostrarTablaMarcaciones(marcaciones, 'tablaAdmin', false);
            } catch (error) { alert('Error: ' + error.message); }
        }
        
        async function filtrarMarcacionesAdmin() {
            try {
                const rutFiltro = document.getElementById('filtroEmpleadoAdmin').value;
                let query = supabase.from('marcaciones').select('*').is('deleted_at', null).order('timestamp_real', { ascending: false }).limit(500);
                if (rutFiltro !== 'todos') query = query.eq('rut_empleado', rutFiltro);
                const { data } = await query;
                mostrarTablaMarcaciones(data, 'tablaAdmin', false);
            } catch (error) { alert('Error: ' + error.message); }
        }
        
        function mostrarTablaMarcaciones(marcaciones, tablaId, mostrarHash) {
            const tabla = document.getElementById(tablaId);
            if (!marcaciones || marcaciones.length === 0) {
                tabla.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #9CA3AF;">No hay marcaciones</td></tr>';
                return;
            }
            let html = '';
            marcaciones.forEach(m => {
                const fecha = new Date(m.timestamp_real);
                const badgeClass = m.tipo_evento === 'ENTRADA' ? 'badge-entrada' : m.tipo_evento === 'SALIDA' ? 'badge-salida' : 'badge-colacion';
                const mapsLink = `https://www.google.com/maps?q=${m.latitud},${m.longitud}`;
                html += `<tr>
                    <td>${m.nombre_empleado}</td>
                    <td>${m.rut_empleado}</td>
                    <td><span class="badge ${badgeClass}">${m.tipo_evento}</span></td>
                    <td>${m.nombre_obra_faena || '-'}</td>
                    <td>${fecha.toLocaleDateString('es-CL')}<br><span style="font-size: 0.75rem;">${fecha.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}</span></td>
                    <td><a href="${mapsLink}" target="_blank" style="color: #DC2626; font-size: 0.75rem;">üìç Ver</a></td>
                    ${mostrarHash ? `<td style="font-size: 0.65rem; font-family: monospace;">${m.hash_verificacion?.substring(0, 12)}...</td>` : ''}
                </tr>`;
            });
            tabla.innerHTML = html;
        }
        
        function exportarDatos() {
            const data = {
                empresa: 'RCJ SERVICIOS GENERALES SPA',
                rut: '77.835.014-9',
                giro: 'Servicios de Ingenier√≠a y Montajes El√©ctricos',
                fecha_exportacion: new Date().toISOString(),
                tipo: 'Reporte Administrativo',
                estadisticas: {
                    empleados: document.getElementById('statEmpleados').textContent,
                    total_marcaciones: document.getElementById('statMarcaciones').textContent,
                    marcaciones_hoy: document.getElementById('statHoy').textContent
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RCJ-Reporte-Admin-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        async function showFiscalizadorView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('fiscalizadorView').classList.remove('hidden');
            cargarDatosFiscalizador();
        }
        
        async function cargarDatosFiscalizador() {
            try {
                const { data: empleados } = await supabase.from('empleados').select('*').eq('activo', true);
                const { data: marcaciones } = await supabase.from('marcaciones').select('*').is('deleted_at', null).order('timestamp_real', { ascending: false }).limit(500);
                
                document.getElementById('statEmpleadosFisc').textContent = empleados?.length || 0;
                document.getElementById('statMarcacionesFisc').textContent = marcaciones?.length || 0;
                
                mostrarTablaMarcaciones(marcaciones, 'tablaFiscalizador', true);
            } catch (error) { alert('Error: ' + error.message); }
        }
        
        function exportarDatosFiscalizador() {
            const data = {
                empleador: {
                    razon_social: 'RCJ SERVICIOS GENERALES SPA',
                    rut: '77.835.014-9',
                    giro: 'Servicios de Ingenier√≠a y Montajes El√©ctricos',
                    direccion: 'Eusebio Lillo 1267, Granja, Rancagua'
                },
                fiscalizacion: {
                    fecha: new Date().toISOString(),
                    fiscalizador: currentUser.nombre,
                    certificacion: 'Sistema cumple 100% Dictamen 1140/27 DT'
                },
                estadisticas: {
                    empleados_registrados: document.getElementById('statEmpleadosFisc').textContent,
                    total_marcaciones: document.getElementById('statMarcacionesFisc').textContent
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RCJ-Fiscalizacion-DT-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function logout() {
            currentUser = null;
            todasMarcaciones = [];
            ['employeeView', 'historialView', 'adminView', 'fiscalizadorView'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('inputId').value = '';
            document.getElementById('inputPass').value = '';
            document.getElementById('selectObra').value = '';
        }
    </script>
</body>
</html>
